<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinanceFlow Pro | Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root { --sidebar-width: 260px; --dark-bg: #1a1e29; }
        body { background-color: #f4f7f6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; height: 100vh; overflow: hidden; }
        
        #sidebar { width: var(--sidebar-width); background: var(--dark-bg); height: 100vh; position: fixed; color: white; padding-top: 20px; z-index: 1000; }
        .nav-link { color: #aeb1b7; padding: 15px 25px; display: block; text-decoration: none; transition: all 0.3s ease; border-left: 4px solid transparent; cursor: pointer; }
        .nav-link:hover, .nav-link.active { background: #2c323f; color: white; border-left: 4px solid #0d6efd; }
        
        #main-content { margin-left: var(--sidebar-width); height: 100vh; overflow-y: auto; padding: 40px; }
        .tab-content { display: none; animation: fadeIn 0.3s ease-in-out; }
        .tab-content.active { display: block; }
        
        .card { border: none; box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075); border-radius: 15px; }
        .stat-card { padding: 25px; border-radius: 15px; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #main-content::-webkit-scrollbar { width: 6px; }
        #main-content::-webkit-scrollbar-thumb { background: #d1d1d1; border-radius: 10px; }
    </style>
</head>
<body>

<div id="sidebar">
    <div class="px-4 mb-5">
        <h3 class="fw-bold text-white"><i class="bi bi-rocket-takeoff-fill text-primary me-2"></i>FinanceFlow</h3>
    </div>
    <nav>
        <a class="nav-link active" onclick="showTab('dashboard', event)"><i class="bi bi-speedometer2 me-2"></i> Dashboard</a>
        <a class="nav-link" onclick="showTab('add-tx', event)"><i class="bi bi-plus-square-dotted me-2"></i> Add Transaction</a>
        <a class="nav-link" onclick="showTab('savings', event)"><i class="bi bi-piggy-bank me-2"></i> Savings Roadmap</a>
        <a class="nav-link" onclick="showTab('history', event)"><i class="bi bi-journal-text me-2"></i> History Ledger</a>
        <a class="nav-link" onclick="showTab('analytics', event)"><i class="bi bi-graph-up-arrow me-2"></i> Analytics</a>
    </nav>
    <div class="position-absolute bottom-0 w-100 p-3">
        <button class="btn btn-outline-info btn-sm w-100 mb-2" onclick="exportData()"><i class="bi bi-cloud-download me-1"></i> Save Backup</button>
        <label class="btn btn-outline-light btn-sm w-100 mb-2" style="cursor: pointer;">
            <i class="bi bi-cloud-upload me-1"></i> Load Backup
            <input type="file" id="importInput" hidden onchange="importData(event)">
        </label>
        <button class="btn btn-danger btn-sm w-100 mb-4" onclick="generatePDF()"><i class="bi bi-file-earmark-pdf me-1"></i> Export PDF</button>
    </div>
</div>

<div id="main-content">
    <div id="dashboard" class="tab-content active"></div>

    <div id="add-tx" class="tab-content">
        <h2 class="fw-bold mb-4">New Transaction</h2>
        <div id="form-container"></div>
    </div>

    <div id="savings" class="tab-content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="fw-bold mb-0">Savings Roadmap</h2>
            <button class="btn btn-outline-primary btn-sm" onclick="setupSavingsGoal()"><i class="bi bi-pencil"></i> Edit Goal</button>
        </div>
        <div id="savings-container"></div>
    </div>

    <div id="history" class="tab-content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="fw-bold mb-0">Transaction Ledger</h2>
            <button class="btn btn-outline-danger btn-sm" onclick="clearAllData()">Reset All</button>
        </div>
        <div id="history-list"></div>
    </div>

    <div id="analytics" class="tab-content">
        <h2 class="mb-4 fw-bold">Deep Analytics</h2>
        <div class="row">
            <div class="col-md-7 mb-4"><div class="card p-4 h-100 shadow-sm"><canvas id="cashFlowChart"></canvas></div></div>
            <div class="col-md-5 mb-4"><div class="card p-4 h-100 shadow-sm"><canvas id="categoryChart"></canvas></div></div>
        </div>
    </div>
</div>

<script src="transactions.js"></script>
<script src="history.js"></script>
<script src="charts.js"></script>
<script src="savings.js"></script>

<script>
    let transactions = JSON.parse(localStorage.getItem('txs')) || [];
    let currentPeriod = new Date().toISOString().slice(0, 7); 

    function saveData() { 
        localStorage.setItem('txs', JSON.stringify(transactions)); 
    }

    function showTab(tabId, event) {
        if(event) event.preventDefault();
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
        
        document.getElementById(tabId).classList.add('active');
        if(event) event.currentTarget.classList.add('active');

        if(tabId === 'dashboard') renderSummary();
        if(tabId === 'history') renderHistory();
        if(tabId === 'analytics') renderAnalytics();
        if(tabId === 'savings') renderSavings();
    }

    function changePeriod(val) {
        currentPeriod = val;
        renderSummary();
        if(document.getElementById('history').classList.contains('active')) renderHistory();
        if(document.getElementById('analytics').classList.contains('active')) renderAnalytics();
    }

    function renderSummary() {
        const filtered = transactions.filter(t => t.date.startsWith(currentPeriod));
        let monthInc = 0, monthExp = 0;
        filtered.forEach(t => t.type === 'deposit' ? monthInc += parseFloat(t.amount) : monthExp += parseFloat(t.amount));

        let totalInc = 0, totalExp = 0;
        transactions.forEach(t => t.type === 'deposit' ? totalInc += parseFloat(t.amount) : totalExp += parseFloat(t.amount));
        const lifetimeBalance = totalInc - totalExp;

        // Calculate Savings Progress for Dashboard Card
        const goalName = localStorage.getItem('savingsGoalName') || "General Savings";
        const goalAmount = parseFloat(localStorage.getItem('savingsGoalAmount')) || 1000;
        const totalSavings = transactions
            .filter(t => t.category === "Savings")
            .reduce((acc, t) => {
                const amt = parseFloat(t.amount);
                return t.type === 'expense' ? acc + amt : acc - amt; // Expense increases savings, Deposit decreases it
            }, 0);
        const progressPercent = goalAmount > 0 ? Math.min((totalSavings / goalAmount) * 100, 100).toFixed(0) : 0;

        const recent = [...filtered].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5);

        document.getElementById('dashboard').innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="fw-bold mb-0">Financial Summary</h2>
                    <input type="month" class="form-control form-control-sm mt-2" value="${currentPeriod}" onchange="changePeriod(this.value)" style="width: auto;">
                </div>
                <div class="text-end">
                    <small class="text-muted text-uppercase fw-bold">Available Balance</small>
                    <h3 class="text-primary fw-bold mb-0">$${lifetimeBalance.toLocaleString(undefined, {minimumFractionDigits: 2})}</h3>
                </div>
            </div>

            <div class="card p-4 mb-4 border-0 shadow-sm bg-white">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="fw-bold mb-0"><i class="bi bi-piggy-bank text-success me-2"></i>Goal: ${goalName}</h6>
                    <span class="badge bg-success-subtle text-success">${progressPercent}%</span>
                </div>
                <div class="progress" style="height: 10px; border-radius: 5px;">
                    <div class="progress-bar bg-success" style="width: ${progressPercent}%"></div>
                </div>
                <div class="d-flex justify-content-between mt-2 small text-muted">
                    <span>$${totalSavings.toLocaleString()} saved</span>
                    <span>Target: $${goalAmount.toLocaleString()}</span>
                </div>
            </div>

            <div class="row g-4 mb-5">
                <div class="col-md-4">
                    <div class="card stat-card bg-dark text-white shadow">
                        <small class="opacity-50 text-uppercase">Monthly Cash Flow</small>
                        <h1 class="fw-bold">$${(monthInc - monthExp).toLocaleString()}</h1>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card stat-card bg-white border-bottom border-success border-4 shadow-sm">
                        <small class="text-muted text-uppercase">Income</small>
                        <h2 class="text-success fw-bold">$${monthInc.toLocaleString()}</h2>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card stat-card bg-white border-bottom border-danger border-4 shadow-sm">
                        <small class="text-muted text-uppercase">Expenses</small>
                        <h2 class="text-danger fw-bold">$${monthExp.toLocaleString()}</h2>
                    </div>
                </div>
            </div>

            <div class="row g-4">
                <div class="col-lg-8">
                    <div class="card p-4 h-100 shadow-sm">
                        <h6 class="fw-bold mb-4">Monthly Overview</h6>
                        <div style="height:300px"><canvas id="summaryChart"></canvas></div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card h-100 shadow-sm overflow-hidden">
                        <div class="card-header bg-white fw-bold py-3">Recent Transactions</div>
                        <div class="card-body p-0">
                            ${recent.map(t => `
                                <div class="p-3 border-bottom d-flex justify-content-between align-items-center">
                                    <div><div class="fw-bold small">${t.name}</div><small class="text-muted">${t.date}</small></div>
                                    <span class="fw-bold ${t.type === 'deposit' ? 'text-success' : 'text-danger'}">
                                        ${t.type === 'deposit' ? '+' : '-'}$${parseFloat(t.amount).toFixed(2)}
                                    </span>
                                </div>
                            `).join('') || '<p class="p-4 text-center text-muted">No data available</p>'}
                        </div>
                    </div>
                </div>
            </div>`;
        
        const ctx = document.getElementById('summaryChart');
        if(ctx) {
            new Chart(ctx, { type: 'bar', data: { labels: ['Income', 'Expenses'], datasets: [{ data: [monthInc, monthExp], backgroundColor: ['#1cc88a', '#e74a3b'], borderRadius: 10 }] }, options: { maintainAspectRatio: false, plugins: { legend: { display: false } } } });
        }
    }

    // PDF and Backup Logic
    function generatePDF() {
        if (transactions.length === 0) {
            alert("No data to export.");
            return;
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // 1. Calculate Lifetime Totals
        let totalIncome = 0;
        let totalExpenses = 0;
        transactions.forEach(t => {
            const amt = parseFloat(t.amount);
            t.type === 'deposit' ? totalIncome += amt : totalExpenses += amt;
        });
        const balance = totalIncome - totalExpenses;

        // 2. Add Header & Title
        doc.setFontSize(20);
        doc.setTextColor(26, 30, 41); // Dark Navy
        doc.text("FinanceFlow Pro Statement", 14, 20);
        
        doc.setFontSize(10);
        doc.setTextColor(100);
        doc.text(`Generated on: ${new Date().toLocaleString()}`, 14, 28);

        // 3. Add Summary Box
        doc.setDrawColor(220, 220, 220);
        doc.setFillColor(245, 247, 246);
        doc.roundedRect(14, 35, 182, 30, 3, 3, 'FD');

        doc.setFontSize(11);
        doc.setTextColor(26, 30, 41);
        doc.setFont(undefined, 'bold');
        doc.text("ACCOUNT OVERVIEW (LIFETIME)", 18, 42);

        doc.setFont(undefined, 'normal');
        doc.setFontSize(10);
        doc.text(`Total Income: `, 18, 50);
        doc.setTextColor(28, 200, 138); // Green
        doc.text(`+$${totalIncome.toLocaleString(undefined, {minimumFractionDigits: 2})}`, 55, 50);

        doc.setTextColor(26, 30, 41);
        doc.text(`Total Spending: `, 18, 57);
        doc.setTextColor(231, 74, 59); // Red
        doc.text(`-$${totalExpenses.toLocaleString(undefined, {minimumFractionDigits: 2})}`, 55, 57);

        doc.setTextColor(26, 30, 41);
        doc.text(`Current Balance: `, 110, 54);
        doc.setFontSize(14);
        doc.setFont(undefined, 'bold');
        doc.text(`$${balance.toLocaleString(undefined, {minimumFractionDigits: 2})}`, 140, 54);

        // 4. Add Transaction Table (Shows all transactions for all months)
        const rows = transactions.map(t => [
            t.date, 
            t.name, 
            t.category, 
            t.type.toUpperCase(), 
            `${t.type === 'deposit' ? '+' : '-'}$${parseFloat(t.amount).toFixed(2)}`
        ]);

        doc.autoTable({
            startY: 75,
            head: [['Date', 'Description', 'Category', 'Type', 'Amount']],
            body: rows,
            headStyles: { fillColor: [26, 30, 41], fontSize: 10 },
            bodyStyles: { fontSize: 9 },
            alternateRowStyles: { fillColor: [250, 250, 250] },
            didParseCell: function (data) {
                if (data.column.index === 4 && data.cell.section === 'body') {
                    const text = data.cell.raw;
                    if (text.startsWith('+')) data.cell.styles.textColor = [28, 200, 138];
                    if (text.startsWith('-')) data.cell.styles.textColor = [231, 74, 59];
                }
            }
        });

        // 5. Save the file
        doc.save(`FinanceFlow_Full_Report_${new Date().toISOString().split('T')[0]}.pdf`);
    }

    function exportData() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(transactions));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "finance_backup.json");
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    function importData(event) {
        const reader = new FileReader();
        reader.onload = (e) => {
            transactions = JSON.parse(e.target.result);
            saveData();
            renderSummary();
        };
        reader.readAsText(event.target.files[0]);
    }

    function clearAllData() {
        if(confirm("Are you sure? This will delete all history.")) {
            transactions = [];
            saveData();
            renderSummary();
        }
    }

    window.onload = renderSummary;
</script>
</body>
</html>